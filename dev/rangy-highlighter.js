/**
 * Highlighter module for Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Depends on Rangy core, TextRange and CssClassApplier modules.
 *
 * Copyright 2014, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.20140716
 * Build date: 16 July 2014
 */
rangy.createModule("Highlighter",["ClassApplier"],function(t){function e(t,e){return t.characterRange.start-e.characterRange.start}function n(t,e){this.type=t,this.converterCreator=e}function r(t,e){p[t]=new n(t,e)}function i(t){var e=p[t];if(e instanceof n)return e.create();throw new Error("Highlighter type '"+t+"' is not valid")}function a(t,e){this.start=t,this.end=e}function s(t,e,n,r,i,a){i?(this.id=i,u=Math.max(u,i+1)):this.id=u++,this.characterRange=e,this.doc=t,this.classApplier=n,this.converter=r,this.containerElementId=a||null,this.applied=!1}function h(t,e){e=e||"textContent",this.doc=t||document,this.classAppliers={},this.highlights=[],this.converter=i(e)}var o=t.dom,c=o.arrayContains,g=o.getBody,l=[].forEach?function(t,e){t.forEach(e)}:function(t,e){for(var n=0,r=t.length;r>n;++n)e(t[n])},u=1,p={};n.prototype.create=function(){var t=this.converterCreator();return t.type=this.type,t},t.registerHighlighterType=r,a.prototype={intersects:function(t){return this.start<t.end&&this.end>t.start},union:function(t){return new a(Math.min(this.start,t.start),Math.max(this.end,t.end))},intersection:function(t){return new a(Math.max(this.start,t.start),Math.min(this.end,t.end))},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}},a.fromCharacterRange=function(t){return new a(t.start,t.end)};var f={rangeToCharacterRange:function(t,e){var n=t.getBookmark(e);return new a(n.start,n.end)},characterRangeToRange:function(e,n,r){var i=t.createRange(e);return i.moveToBookmark({start:n.start,end:n.end,containerNode:r}),i},serializeSelection:function(t,e){for(var n=t.getAllRanges(),r=n.length,i=[],a=1==r&&t.isBackward(),s=0,h=n.length;h>s;++s)i[s]={characterRange:this.rangeToCharacterRange(n[s],e),backward:a};return i},restoreSelection:function(t,e,n){t.removeAllRanges();for(var r,i,a,s=t.win.document,h=0,o=e.length;o>h;++h)i=e[h],a=i.characterRange,r=this.characterRangeToRange(s,i.characterRange,n),t.addRange(r,i.backward)}};r("textContent",function(){return f}),r("TextRange",function(){var e;return function(){if(!e){var n=t.modules.TextRange;if(!n)throw new Error("TextRange module is missing.");if(!n.supported)throw new Error("TextRange module is present but not supported.");e={rangeToCharacterRange:function(t,e){return a.fromCharacterRange(t.toCharacterRange(e))},characterRangeToRange:function(e,n,r){var i=t.createRange(e);return i.selectCharacters(r,n.start,n.end),i},serializeSelection:function(t,e){return t.saveCharacterRanges(e)},restoreSelection:function(t,e,n){t.restoreCharacterRanges(n,e)}}}return e}}()),s.prototype={getContainerElement:function(){return this.containerElementId?this.doc.getElementById(this.containerElementId):g(this.doc)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(t){this.characterRange=this.converter.rangeToCharacterRange(t,this.getContainerElement())},getText:function(){return this.getRange().toString()},containsElement:function(t){return this.getRange().containsNodeContents(t.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange()),this.applied=!1},apply:function(){this.classApplier.applyToRange(this.getRange()),this.applied=!0},getHighlightElements:function(){return this.classApplier.getElementsWithClassIntersectingRange(this.getRange())},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.cssClass+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}},h.prototype={addClassApplier:function(t){this.classAppliers[t.cssClass]=t},getHighlightForElement:function(t){for(var e=this.highlights,n=0,r=e.length;r>n;++n)if(e[n].containsElement(t))return e[n];return null},removeHighlights:function(t){for(var e,n=0,r=this.highlights.length;r>n;++n)e=this.highlights[n],c(t,e)&&(e.unapply(),this.highlights.splice(n--,1))},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(t){{var e=[],n=this.highlights;this.converter}return l(t,function(t){l(n,function(n){t.intersectsRange(n.getRange())&&!c(e,n)&&e.push(n)})}),e},highlightCharacterRanges:function(e,n,r){var i,h,o,c=this.highlights,g=this.converter,u=this.doc,p=[],f=this.classAppliers[e];r=r||null;var d,R,v;r&&(d=this.doc.getElementById(r),d&&(R=t.createRange(this.doc),R.selectNodeContents(d),v=new a(0,R.toString().length)));var m,C,w;for(i=0,h=n.length;h>i;++i){for(m=n[i],w=!1,v&&(m=m.intersection(v)),o=0;o<c.length;++o)r==c[o].containerElementId&&(C=c[o].characterRange,C.intersects(m)&&(p.push(c[o]),c[o]=new s(u,C.union(m),f,g,null,r)));w||c.push(new s(u,m,f,g,null,r))}l(p,function(t){t.unapply()});var y=[];return l(c,function(t){t.applied||(t.apply(),y.push(t))}),y},highlightRanges:function(e,n,r){var i,a=[],s=this.converter,h=r?r.id:null;return r&&(i=t.createRange(r),i.selectNodeContents(r)),l(n,function(t){var e=r?i.intersection(t):t;a.push(s.rangeToCharacterRange(e,r||g(t.getDocument())))}),this.highlightCharacterRanges(a,n,h)},highlightSelection:function(e,n,r){var i=this.converter;n=n||t.getSelection();var s=this.classAppliers[e],h=n.win.document,o=r?h.getElementById(r):g(h);if(!s)throw new Error("No class applier found for class '"+e+"'");var c=i.serializeSelection(n,o),u=[];l(c,function(t){u.push(a.fromCharacterRange(t.characterRange))});var p=this.highlightCharacterRanges(e,u,r);return i.restoreSelection(n,c,o),p},unhighlightSelection:function(e){e=e||t.getSelection();var n=this.getIntersectingHighlights(e.getAllRanges());return this.removeHighlights(n),e.removeAllRanges(),n},getHighlightsInSelection:function(e){return e=e||t.getSelection(),this.getIntersectingHighlights(e.getAllRanges())},selectionOverlapsHighlight:function(t){return this.getHighlightsInSelection(t).length>0},serialize:function(t){var n=this.highlights;n.sort(e);var r=["type:"+this.converter.type];return l(n,function(e){var n=e.characterRange,i=[n.start,n.end,e.id,e.classApplier.cssClass,e.containerElementId];t&&t.serializeHighlightText&&i.push(e.getText()),r.push(i.join("$"))}),r.join("|")},deserialize:function(t){var e,n,r,h=t.split("|"),o=[],c=h[0],l=!1;if(!c||!(e=/^type:(\w+)$/.exec(c)))throw new Error("Serialized highlights are invalid.");n=e[1],n!=this.converter.type&&(r=i(n),l=!0),h.shift();for(var u,p,f,d,R,v,m=h.length;m-->0;){if(v=h[m].split("$"),f=new a(+v[0],+v[1]),d=v[4]||null,R=d?this.doc.getElementById(d):g(this.doc),l&&(f=this.converter.rangeToCharacterRange(r.characterRangeToRange(this.doc,f,R),R)),u=this.classAppliers[v[3]],!u)throw new Error("No class applier found for class '"+v[3]+"'");p=new s(this.doc,f,u,this.converter,parseInt(v[2]),d),p.apply(),o.push(p)}this.highlights=o}},t.Highlighter=h,t.createHighlighter=function(t,e){return new h(t,e)}});